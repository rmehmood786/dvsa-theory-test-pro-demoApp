<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DVSA Theory Test Pro – Revamp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary: #2563eb; /* slightly deeper blue */
      --secondary: #0f172a; /* slate-900 */
      --success: #16a34a;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #0891b2;
      --light: #f8fafc;
      --dark: #0b1220;
      --background: #f5f7fb;
      --card-bg: #ffffff;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --muted-border: #e5e7eb;
    }

    [data-theme="dark"] {
      --primary: #60a5fa;
      --secondary: #1f2937;
      --background: #0b1220;
      --card-bg: #0f172a;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --muted-border: #1f2937;
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell,
        Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--background);
      color: var(--text-primary);
      margin: 0;
    }

    /* NAV */
    .navbar {
      background: linear-gradient(90deg, var(--primary), #334155);
      box-shadow: 0 2px 10px rgb(0 0 0 / 8%);
      padding: .6rem 1rem;
    }

    .app-container { max-width: 1024px; margin: 0 auto; padding: 12px; }

    /* CARDS */
    .card {
      border: 1px solid var(--muted-border);
      border-radius: 16px;
      background: var(--card-bg);
      box-shadow: 0 6px 16px rgb(0 0 0 / 6%);
    }
    .card-header {
      background: linear-gradient(90deg, var(--secondary), #415a8b);
      color: #fff;
      border-radius: 16px 16px 0 0 !important;
      font-weight: 600; padding: 10px 14px;
    }

    /* SECTION TITLE */
    .section-title {
      font-weight: 800; color: var(--secondary); text-align: center; margin: 6px 0 12px;
    }

    /* COMPACT CONTROLS */
    .toolbar {
      display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: center;
    }
    .chip {
      border: 1px solid var(--muted-border); border-radius: 999px; padding: 6px 12px;
      background: #eef2ff; color: #1e3a8a; font-weight: 600; cursor: pointer;
    }

    /* BUTTONS — compact, responsive */
    .btn-primary, .btn-secondary, .btn-outline-primary, .btn-info, .btn-success {
      border-radius: 999px; font-weight: 700; padding: 8px 14px; border: none;
    }
    .btn-primary { background: linear-gradient(90deg, var(--primary), #3b82f6); }
    .btn-info { background: linear-gradient(90deg, #7c3aed, #2563eb); }

    /* OPTION GRID (fixes too-wide buttons) */
    .options-grid {
      display: grid; gap: 10px;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 576px) { .options-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 992px) { .options-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .option {
      display: grid; grid-template-columns: 44px 1fr; align-items: center; gap: 10px;
      border: 2px solid var(--muted-border); border-radius: 12px; padding: 10px 12px;
      background: var(--card-bg); cursor: pointer; transition: transform .12s ease, border-color .2s;
      max-width: 100%;
    }
    .option:hover { transform: translateY(-1px); border-color: var(--primary); }
    .option.selected { border-color: #60a5fa; box-shadow: 0 4px 10px rgb(37 99 235 / 18%); }
    .option.correct { border-color: var(--success); background: rgba(34,197,94,.06); }
    .option.incorrect { border-color: var(--danger); background: rgba(239,68,68,.06); }
    .pill { width: 32px; height: 32px; display: grid; place-items: center; border-radius: 999px; background: #e5e7eb; font-weight: 800; }

    /* Urdu column kept but compacted; switchable side-by-side vs stacked */
    .bilingual { display: grid; gap: 8px; }
    @media (min-width: 768px) { .bilingual { grid-template-columns: 1fr 1fr; } }
    .urdu-text { font-size: 1.05em; line-height: 1.55; text-align: right; direction: rtl; }

    /* PROGRESS */
    .progress { height: 10px; border-radius: 999px; background: #e5e7eb; overflow: hidden; }
    .progress-bar { background: linear-gradient(90deg, var(--primary), #22d3ee); transition: width .25s ease; }

    .score-display { font-weight: 800; }
    .timer-display { font-weight: 800; }

    /* BOTTOM NAV (mobile-friendly controls) */
    .bottom-nav {
      position: sticky; bottom: 0; z-index: 50; padding: 10px; background: rgb(255 255 255 / .85);
      backdrop-filter: blur(6px); border-top: 1px solid var(--muted-border); display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center;
    }
    [data-theme="dark"] .bottom-nav { background: rgb(15 23 42 / .6); }

    /* MODALS */
    .modal-content { border-radius: 16px; }

    /* Utility */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand"><i class="fas fa-car me-2"></i>DVSA Theory Pro</span>
      <div class="d-flex align-items-center gap-2">
        <div class="form-check form-switch text-white m-0">
          <input class="form-check-input" type="checkbox" id="theme-toggle" />
          <label class="form-check-label" for="theme-toggle">Dark</label>
        </div>
      </div>
    </div>
  </nav>

  <div class="app-container">
    <!-- DASHBOARD -->
    <div id="dashboard-view" class="mt-3">
      <div class="card mb-3">
        <div class="card-header"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</div>
        <div class="card-body">
          <h3 class="section-title">DVSA Theory Test Pro</h3>
          <p class="text-center text-muted">Prepare for your driving theory test with questions in English and Urdu.</p>

          <div class="row g-3 mt-1">
            <div class="col-6">
              <div class="p-3 border rounded-4 text-center">
                <div class="fs-3 fw-bold" id="total-questions-stats">50</div>
                <div class="text-muted">Questions</div>
              </div>
            </div>
            <div class="col-6">
              <div class="p-3 border rounded-4 text-center">
                <div class="fs-3 fw-bold" id="mastery-score">0%</div>
                <div class="text-muted">Mastery</div>
              </div>
            </div>
          </div>

          <div class="toolbar mt-3">
            <button class="btn btn-primary" id="start-quiz-btn"><i class="fas fa-play-circle me-2"></i>Start Test</button>
            <button class="btn btn-outline-primary" id="bookmarked-questions-btn"><i class="fas fa-bookmark me-2"></i>Bookmarks</button>
            <button class="btn btn-secondary" id="reset-data"><i class="fas fa-rotate me-2"></i>Reset Progress</button>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header"><i class="fas fa-cog me-2"></i>Settings</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label">Questions</label>
                  <select class="form-select" id="questions-limit">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                    <option value="50" selected>All</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Time</label>
                  <select class="form-select" id="time-limit">
                    <option value="5">5 Min</option>
                    <option value="10">10 Min</option>
                    <option value="20">20 Min</option>
                    <option value="0" selected>No Limit</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Mode</label>
                  <select class="form-select" id="mode-select">
                    <option value="practice" selected>Practice (hints, TTS)</option>
                    <option value="exam">Exam (no hints, no TTS)</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Density</label>
                  <select class="form-select" id="density-select">
                    <option value="comfortable" selected>Comfortable</option>
                    <option value="compact">Compact</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">TTS Speed</label>
                  <input type="range" min="0.7" max="1.3" step="0.1" value="0.9" id="tts-speed" class="form-range" />
                </div>
                <div class="col-6">
                  <label class="form-label">Auto Read</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="read-aloud-setting" checked />
                    <label class="form-check-label" for="read-aloud-setting">Enabled</label>
                  </div>
                </div>
                <div class="col-6">
                  <label class="form-label">Hints</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="hints-setting" checked />
                    <label class="form-check-label" for="hints-setting">Show</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header"><i class="fas fa-graduation-cap me-2"></i>Categories</div>
            <div class="card-body">
              <div class="d-flex flex-wrap gap-2 justify-content-center" id="category-filter"></div>
              <div class="mt-3 small text-muted text-center">Tip: Press <kbd>A</kbd>/<kbd>B</kbd>/<kbd>C</kbd>/<kbd>D</kbd> to answer; <kbd>N</kbd>/<kbd>P</kbd> for next/prev; <kbd>H</kbd> to toggle hint.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header"><i class="fas fa-info-circle me-2"></i>How to Use</div>
        <div class="card-body">
          <ol class="mb-3">
            <li>Click an answer to check instantly.</li>
            <li>Use the sticky bottom navigation on mobile.</li>
            <li>Add to Home Screen for quick access.</li>
          </ol>
          <button class="btn btn-outline-primary" id="installButton"><i class="fas fa-plus-circle me-2"></i>Add to Home Screen</button>
        </div>
      </div>
    </div>

    <!-- QUIZ VIEW -->
    <div id="quiz-view" class="hidden">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-bold">Q <span id="current-question">1</span>/<span id="total-questions">50</span></div>
        <div class="d-flex align-items-center gap-2">
          <div class="timer-display"><i class="fas fa-clock me-1"></i><span id="timer">00:00</span></div>
          <div class="score-display">Score: <span id="score">0</span>/<span id="total-answered">0</span></div>
        </div>
      </div>
      <div class="progress mb-3"><div id="progress-bar" class="progress-bar" style="width:0%"></div></div>

      <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div class="bilingual">
            <div class="fw-semibold">Question</div>
            <div class="fw-semibold urdu-text">سوال</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-sm btn-outline-primary" id="quick-jump"><i class="fas fa-th me-1"></i>Jump</button>
            <button class="btn btn-sm btn-outline-primary" id="bookmark-question" title="Bookmark"><i class="far fa-bookmark"></i></button>
          </div>
        </div>
        <div class="card-body">
          <div id="sign-container" class="text-center mb-3 hidden"><img id="road-sign" class="img-fluid rounded-3" alt="Road Sign" /></div>

          <div class="bilingual mb-2">
            <p id="question-en" class="m-0 fw-semibold"></p>
            <p id="question-ur" class="m-0 fw-semibold urdu-text"></p>
          </div>

          <div id="hint-box" class="alert alert-info py-2 px-3 hidden"><i class="fas fa-lightbulb me-2"></i><span id="hint-text"></span></div>

          <div class="d-flex justify-content-center gap-2 my-2">
            <button class="btn btn-info btn-sm" id="read-en"><i class="fas fa-volume-up me-1"></i>English</button>
            <button class="btn btn-info btn-sm" id="read-ur"><i class="fas fa-volume-up me-1"></i>اردو</button>
            <button class="btn btn-secondary btn-sm" id="stop-tts"><i class="fas fa-stop me-1"></i>Stop</button>
          </div>

          <div id="options-container" class="options-grid"></div>

          <div id="feedback" class="alert mt-3 hidden"><span id="feedback-text"></span></div>
        </div>

        <!-- Sticky bottom controls -->
        <div class="bottom-nav rounded-top-4">
          <button id="prev-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i></button>
          <button id="hint-btn" class="btn btn-outline-primary"><i class="fas fa-lightbulb"></i></button>
          <button id="next-btn" class="btn btn-success"><i class="fas fa-arrow-right"></i></button>
        </div>
      </div>
    </div>

    <!-- RESULTS VIEW -->
    <div id="results-view" class="hidden">
      <div class="card">
        <div class="card-header">Test Results</div>
        <div class="card-body text-center">
          <div class="display-6 fw-bold"><span id="final-score">0</span>/<span id="total-questions-final">50</span></div>
          <p id="result-message" class="fw-bold mt-2">Well done!</p>
          <p id="result-detail" class="text-muted">You scored 0 out of 50 questions correctly.</p>
          <div class="row g-3 mt-1">
            <div class="col-6"><div class="p-3 border rounded-4"><div class="fs-4 fw-bold" id="result-time">00:00</div><div class="text-muted">Time</div></div></div>
            <div class="col-6"><div class="p-3 border rounded-4"><div class="fs-4 fw-bold" id="result-percentage">0%</div><div class="text-muted">Score</div></div></div>
          </div>
          <div class="toolbar mt-3">
            <button id="review-answers" class="btn btn-info"><i class="fas fa-search me-2"></i>Review</button>
            <button id="restart-quiz" class="btn btn-primary"><i class="fas fa-redo me-2"></i>Retry</button>
            <button id="back-to-dashboard" class="btn btn-secondary"><i class="fas fa-home me-2"></i>Home</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- REVIEW MODAL -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Review Answers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body"><div id="review-content"></div></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ========================= DATA (short demo set, same structure) =========================
    const questions = [
      { id:1, question:"What does this sign mean?", options:["Mandatory instruction","Warning of a hazard","Route for pedestrians only","Prohibition ending"], correctAnswer:0, explanation:"Circular signs with blue backgrounds give mandatory instructions that must be followed.", explanationUr:"نیلے پس منظر کے ساتھ گول نشانات لازمی ہدایات دیتے ہیں جن پر عمل کرنا ضروری ہے۔", category:"road-signs", hint:"Blue circular signs usually indicate mandatory instructions.", image:"https://via.placeholder.com/300x300/3498db/ffffff?text=Blue+Circle" },
      { id:2, question:"When may you overtake on the left?", options:["When the driver in front signals turning right","In slow-moving traffic queues","When approaching a motorway slip road","When the car in front is slowing down"], correctAnswer:1, explanation:"You may overtake on the left in slow-moving traffic when queues on your right are moving more slowly.", explanationUr:"آپ بائیں طرف اس وقت اوورٹیک کر سکتے ہیں جب آہستہ چلنے والی ٹریفک میں آپ کے دائیں طرف قطاریں زیادہ آہستہ چل رہی ہوں۔", category:"rules", hint:"Overtaking on the left is only allowed in specific situations like slow-moving traffic." },
      { id:3, question:"What does a red traffic light mean?", options:["Stop and wait behind the stop line","Proceed with caution","Stop only if there is traffic","Slow down and prepare to stop"], correctAnswer:0, explanation:"A red light means you must stop and wait behind the stop line until the light changes to green.", explanationUr:"سرخ لائٹ کا مطلب ہے کہ آپ کو اسٹاپ لائن کے پیچھے اس وقت تک رکنا اور انتظار کرنا ہے جب تک کہ لائٹ سبز میں نہ بدل جائے۔", category:"rules", hint:"Red means stop in all traffic situations." },
      { id:4, question:"What is the national speed limit for cars on a single carriageway?", options:["30 mph","50 mph","60 mph","70 mph"], correctAnswer:2, explanation:"The national speed limit for cars on a single carriageway is 60 mph.", explanationUr:"سنگل کیریج وے پر کاروں کے لیے قومی سپیڈ Limit 60 mph ہے۔", category:"rules", hint:"The national speed limit is different for single and dual carriageways." },
      { id:5, question:"What should you do when approaching a zebra crossing?", options:["Speed up to clear the crossing quickly","Slow down and be prepared to stop","Sound your horn to alert pedestrians","Maintain your speed if no one is crossing"], correctAnswer:1, explanation:"You should slow down and be prepared to stop when approaching a zebra crossing.", explanationUr:"زیبرا کراسنگ کے قریب پہنچنے پر آپ کو آہستہ کرنا چاہیے اور رکنے کے لیے تیار رہنا چاہیے۔", category:"safety", hint:"Zebra crossings require drivers to be ready to stop for pedestrians." },
      { id:6, question:"What does this sign mean?", options:["No overtaking","No entry for vehicles","No stopping","No motor vehicles"], correctAnswer:0, explanation:"This sign indicates that overtaking is not allowed.", explanationUr:"یہ نشان ظاہر کرتا ہے کہ اوورٹیکنگ کی اجازت نہیں ہے۔", category:"road-signs", hint:"Circular signs with red borders indicate prohibitions.", image:"https://via.placeholder.com/300x300/e74c3c/ffffff?text=No+Overtaking" },
      { id:7, question:"What should you do when you see this sign?", options:["Stop only if you see children","Slow down and be prepared for children crossing","Continue at same speed","Sound your horn to warn children"], correctAnswer:1, explanation:"This sign warns of children likely to be crossing the road. You should slow down and be prepared to stop.", explanationUr:"یہ نشان بچوں کے سڑک پار کرنے کی امکان سے خبردار کرتا ہے۔ آپ کو آہستہ کرنا چاہیے اور رکنے کے لیے تیار رہنا چاہیے۔", category:"hazard", hint:"Signs with children indicate areas where they might suddenly appear.", image:"https://via.placeholder.com/300x300/f39c12/ffffff?text=Children+Crossing" },
    ];

    // Duplicate to ~50 for demo
    for (let i=8;i<=50;i++){ const o = questions[(i-1)%7]; questions.push({ ...o, id:i }); }

    const urduTranslations = {
      questions:[
        "اس علامت کا کیا مطلب ہے؟",
        "آپ بائیں طرف کب اوورٹیک کر سکتے ہیں؟",
        "سرخ ٹریفک لائٹ کا کیا مطلب ہے؟",
        "سنگل کیریج وے پر کاروں کے لیے قومی سپیڈ Limit کیا ہے؟",
        "زیبرا کراسنگ پر پہنچنے پر آپ کو کیا کرنا چاہیے؟",
        "اس علامت کا کیا مطلب ہے؟",
        "جب آپ یہ علامت دیکھیں تو آپ کو کیا کرنا چاہیے؟",
      ],
      options:[
        ["لازمی ہدایت","خطرے کی وارننگ","صرف پیدل چلنے والوں کے لیے راستہ","پابندی ختم ہونا"],
        ["جب سامنے والا ڈرائیور دائیں مڑنے کا اشارہ کرتا ہے","سست رفتار ٹریفک کے قطاروں میں","جب موٹر وے سلپ روڈ کے قریب پہنچتے ہیں","جب سامنے والی کار آہستہ ہو رہی ہو"],
        ["Stop لائن کے پیچھے رکیں اور انتظار کریں","احتیاط کے ساتھ آگے بڑھیں","صرف اس صورت میں رکیں اگر ٹریفک ہے","آہستہ کریں اور رکنے کے لیے تیار ہوں"],
        ["30 mph","50 mph","60 mph","70 mph"],
        ["کراسنگ کو جلدی سے صاف کرنے کے لیے تیز کریں","آہستہ کریں اور رکنے کے لیے تیار رہیں","پیدل چلنے والوں کو خبردار کرنے کے لیے اپنے ہارن کو بجائیں","اگر کوئی نہیں پار کر رہا ہے تو اپنی رفتار برقرار رکھیں"],
        ["No overtaking","No entry for vehicles","No stopping","No motor vehicles"],
        ["صرف اس صورت میں رکیں اگر آپ بچوں کو دیکھیں","آہستہ کریں اور بچوں کے پار کرنے کے لیے تیار رہیں","ایک ہی رفتار سے جاری رکھیں","بچوں کو خبردار کرنے کے لیے اپنا ہارن بجائیں"],
      ],
      hints:[
        "نیلے گول نشانات عام طور پر لازمی ہدایات کی نشاندہی کرتے ہیں۔",
        "بائیں طرف اوورٹیک کرنا صرف مخصوص حالات میں allowed ہے جیسے آہستہ چلنے والی ٹریفک۔",
        "سرخ کا مطلب ہر ٹریفک صورتحال میں رکنا ہے۔",
        "قومی سپیڈ Limit سنگل اور dual carriageways کے لیے مختلف ہے۔",
        "زیبرا کراسنگ کے لیے ڈرائیوروں کو پیدل چلنے والوں کے لیے رکنے کے لیے تیار رہنا چاہیے۔",
        "سرخ border کے ساتھ سرکلر نشانات پابندیوں کی نشاندہی کرتے ہیں۔",
        "بچوں والے signs ایسے areas کی نشاندہی کرتے ہیں جہاں وہ sudden ظاہر ہو سکتے ہیں۔",
      ],
    };
    for(let i=7;i<50;i++){const n=i%7; urduTranslations.questions.push(urduTranslations.questions[n]); urduTranslations.options.push([...urduTranslations.options[n]]); urduTranslations.hints.push(urduTranslations.hints[n]);}

    // ========================= STATE =========================
    let currentQuestion=0, score=0, totalAnswered=0, selectedOption=null;
    let currentCategory='all', quizQuestions=[], userAnswers={};
    let timerInterval=null, timeRemaining=0, startTime=0;
    let bookmarkedQuestions=[], answeredQuestions={};

    // DOM refs
    const dashboardView = document.getElementById('dashboard-view');
    const quizView = document.getElementById('quiz-view');
    const resultsView = document.getElementById('results-view');
    const questionEnEl = document.getElementById('question-en');
    const questionUrEl = document.getElementById('question-ur');
    const optionsContainer = document.getElementById('options-container');
    const currentQuestionEl = document.getElementById('current-question');
    const totalQuestionsEl = document.getElementById('total-questions');
    const scoreEl = document.getElementById('score');
    const totalAnsweredEl = document.getElementById('total-answered');
    const progressBar = document.getElementById('progress-bar');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');
    const feedbackEl = document.getElementById('feedback');
    const feedbackTextEl = document.getElementById('feedback-text');
    const hintBtn = document.getElementById('hint-btn');
    const hintBox = document.getElementById('hint-box');
    const hintText = document.getElementById('hint-text');
    const bookmarkBtn = document.getElementById('bookmark-question');
    const timerEl = document.getElementById('timer');
    const themeToggle = document.getElementById('theme-toggle');
    const signContainer = document.getElementById('sign-container');
    const roadSign = document.getElementById('road-sign');
    const totalQuestionsStats = document.getElementById('total-questions-stats');
    const masteryScore = document.getElementById('mastery-score');
    const restartQuizBtn = document.getElementById('restart-quiz');
    const reviewAnswersBtn = document.getElementById('review-answers');
    const backToDashboardBtn = document.getElementById('back-to-dashboard');
    const questionsLimit = document.getElementById('questions-limit');
    const timeLimit = document.getElementById('time-limit');
    const readAloudSetting = document.getElementById('read-aloud-setting');
    const hintsSetting = document.getElementById('hints-setting');
    const modeSelect = document.getElementById('mode-select');
    const densitySelect = document.getElementById('density-select');
    const ttsSpeed = document.getElementById('tts-speed');

    const startQuizBtn = document.getElementById('start-quiz-btn');
    const bookmarkedQuestionsBtn = document.getElementById('bookmarked-questions-btn');
    const installBtn = document.getElementById('installButton');
    const resetBtn = document.getElementById('reset-data');

    // Category chips
    const categoryFilter = document.getElementById('category-filter');
    const categories = [ {id:'all',label:'All'}, {id:'road-signs',label:'Signs'}, {id:'rules',label:'Rules'}, {id:'safety',label:'Safety'}, {id:'hazard',label:'Hazard'} ];
    categories.forEach(c=>{
      const el = document.createElement('button');
      el.className = 'chip'; el.dataset.category=c.id; el.textContent=c.label; if(c.id==='all') el.classList.add('active');
      el.addEventListener('click',()=>setCategory(c.id));
      categoryFilter.appendChild(el);
    });

    // ========================= INIT =========================
    document.addEventListener('DOMContentLoaded', () => { loadUserData(); updateDashboardStats(); applyTheme(); attachEvents(); });

    function attachEvents(){
      themeToggle.addEventListener('change', toggleTheme);
      startQuizBtn.addEventListener('click', startQuiz);
      bookmarkedQuestionsBtn.addEventListener('click', showBookmarkedQuestions);
      nextBtn.addEventListener('click', nextQuestion);
      prevBtn.addEventListener('click', prevQuestion);
      hintBtn.addEventListener('click', toggleHint);
      bookmarkBtn.addEventListener('click', toggleBookmark);
      installBtn.addEventListener('click', showPWAInstructions);
      resetBtn.addEventListener('click', resetProgress);

      // Keyboard shortcuts
      window.addEventListener('keydown', (e)=>{
        const map = { 'a':0, 'b':1, 'c':2, 'd':3 };
        if(['INPUT','SELECT','TEXTAREA'].includes(document.activeElement.tagName)) return;
        if(e.key.toLowerCase() in map){ selectOption(map[e.key.toLowerCase()]); }
        if(e.key.toLowerCase()==='n') nextQuestion();
        if(e.key.toLowerCase()==='p') prevQuestion();
        if(e.key.toLowerCase()==='h') toggleHint();
      });

      // Event delegation for options (performance)
      optionsContainer.addEventListener('click', (e)=>{
        const opt = e.target.closest('[data-index]');
        if(!opt) return; selectOption(+opt.dataset.index);
      });

      // TTS controls
      document.getElementById('read-en').addEventListener('click', ()=>readQuestionAloud('en'));
      document.getElementById('read-ur').addEventListener('click', ()=>readQuestionAloud('ur'));
      document.getElementById('stop-tts').addEventListener('click', stopTTS);
      modeSelect.addEventListener('change', applyMode);
      densitySelect.addEventListener('change', applyDensity);
    }

    function loadUserData(){
      try {
        bookmarkedQuestions = JSON.parse(localStorage.getItem('dvsaBookmarks')||'[]');
        answeredQuestions = JSON.parse(localStorage.getItem('dvsaAnswers')||'{}');
        const savedTheme = localStorage.getItem('dvsaTheme'); if(savedTheme){ document.documentElement.setAttribute('data-theme', savedTheme); themeToggle.checked = savedTheme==='dark'; }
      } catch { /* ignore */ }
    }
    function saveUserData(){
      localStorage.setItem('dvsaBookmarks', JSON.stringify(bookmarkedQuestions));
      localStorage.setItem('dvsaAnswers', JSON.stringify(answeredQuestions));
    }

    function updateDashboardStats(){
      const total = questions.length; totalQuestionsStats.textContent = total;
      const correctCount = Object.values(answeredQuestions).filter(a=>a.correct).length;
      const mastery = total? Math.round((correctCount/total)*100):0; masteryScore.textContent = mastery+"%";
    }

    function startQuiz(){
      // Build list according to category
      const category = currentCategory==='all'? null: currentCategory;
      quizQuestions = category? questions.filter(q=>q.category===category): [...questions];
      quizQuestions = shuffleArray(quizQuestions);

      const limit = parseInt(questionsLimit.value); if(limit>0 && limit<quizQuestions.length) quizQuestions = quizQuestions.slice(0, limit);

      currentQuestion=0; score=0; totalAnswered=0; selectedOption=null; userAnswers={};

      const timeLimitMinutes = parseInt(timeLimit.value); timeRemaining = timeLimitMinutes*60; startTime = Date.now();
      if(timeLimitMinutes>0){ startTimer(); } else { timerEl.textContent='No Limit'; clearInterval(timerInterval); }

      totalQuestionsEl.textContent = quizQuestions.length; document.getElementById('total-questions-final').textContent = quizQuestions.length;
      scoreEl.textContent=score; totalAnsweredEl.textContent=totalAnswered;

      dashboardView.classList.add('hidden'); resultsView.classList.add('hidden'); quizView.classList.remove('hidden');
      applyMode(); applyDensity();
      showQuestion();
    }

    function showQuestion(){
      if(currentQuestion>=quizQuestions.length){ finishQuiz(); return; }
      const q = quizQuestions[currentQuestion];

      questionEnEl.textContent = q.question;
      questionUrEl.textContent = urduTranslations.questions[q.id-1];

      if(q.image){ signContainer.classList.remove('hidden'); roadSign.src=q.image; roadSign.alt=q.question; }
      else { signContainer.classList.add('hidden'); }

      currentQuestionEl.textContent = currentQuestion+1;
      optionsContainer.innerHTML = q.options.map((opt,i)=>{
        const ur = urduTranslations.options[q.id-1][i];
        return `<div class="option" data-index="${i}">
                  <div class="pill">${String.fromCharCode(65+i)}</div>
                  <div class="bilingual">
                    <div class="option-text-en">${opt}</div>
                    <div class="option-text-ur urdu-text">${ur}</div>
                  </div>
                </div>`;
      }).join('');

      updateBookmarkButton();
      feedbackEl.classList.add('hidden'); hintBox.classList.add('hidden');
      prevBtn.disabled = currentQuestion===0;
      updateProgressBar();

      if(readAloudSetting.checked && modeSelect.value==='practice'){ readQuestionAloud('en'); }
    }

    function selectOption(index){ selectedOption = index; window.setTimeout(checkAnswer, 80); }

    function checkAnswer(){ if(selectedOption==null) return; const q = quizQuestions[currentQuestion]; const correct = selectedOption===q.correctAnswer;
      answeredQuestions[q.id] = { correct, selectedOption, timestamp: Date.now() };
      userAnswers[currentQuestion] = { question:q, selectedOption, isCorrect:correct };

      // Visual feedback
      [...optionsContainer.querySelectorAll('[data-index]')].forEach(btn=>btn.classList.remove('selected','correct','incorrect'));
      const correctBtns = optionsContainer.querySelectorAll(`[data-index="${q.correctAnswer}"]`);
      correctBtns.forEach(b=>b.classList.add('correct'));
      const selectedBtns = optionsContainer.querySelectorAll(`[data-index="${selectedOption}"]`);
      selectedBtns.forEach(b=>b.classList.add(correct? 'correct':'incorrect'));

      if(correct){ score++; feedbackEl.className='alert alert-success mt-3'; feedbackTextEl.innerHTML = `<i class="fas fa-check-circle me-2"></i>Correct! ${q.explanation}`; }
      else { feedbackEl.className='alert alert-danger mt-3'; feedbackTextEl.innerHTML = `<i class="fas fa-times-circle me-2"></i>Incorrect. ${q.explanation}`; }

      feedbackEl.classList.remove('hidden');
      totalAnswered++; scoreEl.textContent=score; totalAnsweredEl.textContent=totalAnswered; saveUserData();

      // Auto-next
      setTimeout(()=>{ if(currentQuestion<quizQuestions.length-1) nextQuestion(); else finishQuiz(); }, 1100);
    }

    function nextQuestion(){ if(currentQuestion<quizQuestions.length-1){ currentQuestion++; selectedOption=null; showQuestion(); } else { finishQuiz(); } }
    function prevQuestion(){ if(currentQuestion>0){ currentQuestion--; selectedOption=null; showQuestion(); } }

    function finishQuiz(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
      const timeTaken = Math.floor((Date.now()-startTime)/1000); const m=Math.floor(timeTaken/60), s=timeTaken%60;
      document.getElementById('final-score').textContent=score; document.getElementById('result-time').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      const pct = Math.round((score/quizQuestions.length)*100); document.getElementById('result-percentage').textContent=`${pct}%`;
      const rm = document.getElementById('result-message'); rm.textContent = pct>=85? "Excellent! You've passed!": pct>=70? "Good effort, keep practicing": "You need more practice";
      document.getElementById('result-detail').textContent = `You scored ${score} out of ${quizQuestions.length} questions correctly.`;
      quizView.classList.add('hidden'); resultsView.classList.remove('hidden'); updateDashboardStats();
    }

    function showBookmarkedQuestions(){ quizQuestions = questions.filter(q=>bookmarkedQuestions.includes(q.id)); if(!quizQuestions.length){ alert("No bookmarks yet."); return; } startQuiz(); }

    function toggleBookmark(){ const id = quizQuestions[currentQuestion].id; const i=bookmarkedQuestions.indexOf(id); if(i===-1) bookmarkedQuestions.push(id); else bookmarkedQuestions.splice(i,1); updateBookmarkButton(); saveUserData(); }
    function updateBookmarkButton(){ const id = quizQuestions[currentQuestion].id; const on = bookmarkedQuestions.includes(id); bookmarkBtn.innerHTML = on? '<i class="fas fa-bookmark"></i>':'<i class="far fa-bookmark"></i>'; }

    function toggleHint(){ if(modeSelect.value==='exam') return; const q = quizQuestions[currentQuestion]; hintText.textContent = q.hint; hintBox.classList.toggle('hidden'); }

    function updateProgressBar(){ const progress = ((currentQuestion+1)/quizQuestions.length)*100; requestAnimationFrame(()=>{ progressBar.style.width = progress.toFixed(2)+"%"; }); }

    function setCategory(category){ currentCategory=category; [...categoryFilter.querySelectorAll('.chip')].forEach(el=>el.classList.toggle('active', el.dataset.category===category)); }

    function toggleTheme(){ const theme = themeToggle.checked? 'dark':'light'; document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('dvsaTheme', theme); }
    function applyTheme(){ const cur = document.documentElement.getAttribute('data-theme') || 'light'; themeToggle.checked = cur==='dark'; }

    function applyMode(){ const mode = modeSelect.value; if(mode==='exam'){ hintsSetting.checked=false; readAloudSetting.checked=false; } }
    function applyDensity(){ const d = densitySelect.value; document.body.style.setProperty('--option-padding', d==='compact'? '6px 10px':'10px 12px'); const list = document.querySelectorAll('.option'); list.forEach(el=>el.style.padding = d==='compact'? '6px 10px':'10px 12px'); }

    function startTimer(){ clearInterval(timerInterval); updateTimerDisplay(); timerInterval = setInterval(()=>{ timeRemaining--; updateTimerDisplay(); if(timeRemaining<=0){ clearInterval(timerInterval); finishQuiz(); } }, 1000); }
    function updateTimerDisplay(){ const m=Math.floor(timeRemaining/60), s=timeRemaining%60; timerEl.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; timerEl.style.color = timeRemaining<60? 'var(--danger)': timeRemaining<120? 'var(--warning)': 'var(--primary)'; }

    function showPWAInstructions(){ alert("To add this app to your home screen:\n\n• iOS Safari: Share → Add to Home Screen\n• Android Chrome: Menu → Add to Home Screen"); }
    function resetProgress(){ if(confirm('Reset all progress, answers, and bookmarks?')){ localStorage.removeItem('dvsaBookmarks'); localStorage.removeItem('dvsaAnswers'); bookmarkedQuestions=[]; answeredQuestions={}; updateDashboardStats(); alert('Progress reset.'); } }

    function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    // ========================= TTS (Robust, chunked, Urdu-friendly) =========================
    const synth = window.speechSynthesis;
    let voicesCache = []; let speakQueue = []; let speaking=false; let speakTimer=null;

    function loadVoices(){ voicesCache = synth.getVoices(); }
    loadVoices(); if(typeof speechSynthesis !== 'undefined'){ speechSynthesis.onvoiceschanged = loadVoices; }

    function chooseVoice(lang){
      if(!voicesCache.length) loadVoices();
      const pri = voicesCache.find(v=> v.lang && v.lang.toLowerCase().startsWith(lang));
      if(pri) return pri;
      // Urdu fallbacks
      if(lang.startsWith('ur')){
        const alt = voicesCache.find(v=>/hi|ar|fa|ps/i.test(v.lang)); if(alt) return alt;
      }
      return voicesCache[0]||null;
    }

    function chunkText(t){
      // split into ~180-char chunks on sentence boundaries to avoid TTS stalls
      const parts=[]; const max=180; let cur='';
      t.split(/([.!؟?،,؛]\s+)/).forEach(seg=>{
        if((cur+seg).length>max){ if(cur) parts.push(cur.trim()); cur=seg; } else cur+=seg;
      });
      if(cur.trim()) parts.push(cur.trim());
      return parts.length? parts: [t];
    }

    function stopTTS(){ speaking=false; speakQueue=[]; try{ synth.cancel(); }catch{} if(speakTimer){ clearTimeout(speakTimer); speakTimer=null; } }

    function speak(text, lang){
      stopTTS(); const chunks = chunkText(text); const voice = chooseVoice(lang);
      let rate = parseFloat(ttsSpeed.value||'0.9');
      speaking=true;
      const playNext = ()=>{
        if(!speaking) return; if(!chunks.length){ speaking=false; return; }
        const u = new SpeechSynthesisUtterance(chunks.shift());
        if(voice) u.voice=voice; u.lang = voice?.lang || (lang==='ur'? 'ur-PK':'en-GB');
        u.rate = rate; u.pitch = 1; u.volume = 1;
        // watchdog: sometimes onend never fires in some browsers; force-advance
        let ended=false; const watchdog = setTimeout(()=>{ if(!ended){ ended=true; playNext(); } }, Math.max(1500, u.text.length*20));
        u.onend = ()=>{ if(ended) return; clearTimeout(watchdog); playNext(); };
        u.onerror = ()=>{ clearTimeout(watchdog); playNext(); };
        synth.speak(u);
      };
      playNext();
    }

    function readQuestionAloud(language){ const q = quizQuestions[currentQuestion]; if(!q) return; const idx = currentQuestion+1;
      if(language==='en'){
        const text = `Question ${idx}. ${q.question}. Options: ${q.options.map((o,i)=>String.fromCharCode(65+i)+'. '+o).join('. ')}`; speak(text, 'en');
      } else {
        const text = `سوال ${idx}. ${urduTranslations.questions[q.id-1]}. اختیارات: ${urduTranslations.options[q.id-1].map((o,i)=>String.fromCharCode(65+i)+'. '+o).join('، ')}`; speak(text, 'ur');
      }
    }
  </script>
</body>
</html>
